<section class="room-detail">
  <div class="container">
    <header class="hero">
      <div
        class="hero-media"
        *ngIf="heroImg; else noimg"
        [style.backgroundImage]="'url(' + heroImg + ')'"
      ></div>
      <ng-template #noimg><div class="hero-media hero-media--empty"></div></ng-template>

      <div class="hero-copy">
        <span class="eyebrow">Habitación</span>
        <h1 class="title">
          {{ typeName }} — <span class="theme">{{ themeName }}</span>
        </h1>
        <p class="desc" *ngIf="description">{{ description }}</p>

        <div class="chips">
          <span class="chip" *ngIf="basePrice"
            >Desde {{ basePrice | currency : 'COP' : 'symbol' : '1.0-0' }}</span
          >
          <span class="chip" *ngIf="capacity">Capacidad {{ capacity }}</span>
          <span class="chip">Disponibles hoy: {{ availableCount }}</span>
          <span class="chip muted" *ngIf="bookedCount">Reservadas: {{ bookedCount }}</span>
          <span class="chip muted" *ngIf="maintenanceCount"
            >Mantenimiento: {{ maintenanceCount }}</span
          >
        </div>
      </div>
    </header>

    <!-- GRID principal: listado (izq) + formulario (der) -->
    <div class="content-grid">
      <div class="main-col">
        <h3>Habitaciones de este tipo en el hotel</h3>
        <ul class="room-list">
          <li class="room-card" *ngFor="let r of rooms; trackBy: trackByRoom">
            <div class="room-left">
              <strong>{{ r.number }}</strong>
              <span class="muted">Piso {{ r.floor }}</span>
            </div>

            <div class="room-right">
              <span
                class="status-chip"
                [class.avail]="isAvailable(r)"
                [class.booked]="isBooked(r)"
                [class.maint]="isMaintenance(r)"
              >
                {{ statusLabel(r) }}
              </span>

              <button
                *ngIf="isAvailable(r)"
                type="button"
                class="reserve-btn"
                (click)="beginReservation(r)"
              >
                Reservar
              </button>
            </div>
          </li>
        </ul>
      </div>

      <aside class="aside-col">
        <!-- Tarjeta de reserva -->
        <section class="reserve-card" *ngIf="showForm" #reserveSection>
          <h3>Reservar esta categoría</h3>

          <form [formGroup]="reserveForm" (ngSubmit)="reserve()">
            <div class="form-row">
              <label>Habitación</label>
              <select formControlName="roomId">
                <option [ngValue]="null" disabled>Elige una habitación disponible</option>
                <option
                  *ngFor="let r of availableRoomsList; trackBy: trackByRoom"
                  [value]="r.room_id"
                >
                  {{ r.number }} — Piso {{ r.floor }}
                </option>
              </select>
            </div>

            <div class="form-row">
              <label>Check-in</label>
              <input type="date" formControlName="checkIn" [min]="minCheckIn" />
            </div>

            <div class="form-row">
              <label>Check-out <small>(exclusivo)</small></label>
              <input type="date" formControlName="checkOut" [min]="minCheckOut" />
            </div>

            <p class="form-hint">
              * El check-out es exclusivo. Si reservas del 10 al 12, ocupas 10 y 11; el 12 ya no.
            </p>

            <div *ngIf="submitError" class="error">{{ submitError }}</div>

            <button class="primary" type="submit" [disabled]="isSubmitting || reserveForm.invalid">
              {{ isSubmitting ? 'Reservando…' : 'Reservar' }}
            </button>
          </form>
        </section>

        <section class="reserve-cta" *ngIf="!showForm && availableCount > 0">
          <p>Selecciona una habitación <em>Disponible</em> para continuar con tu reserva.</p>
        </section>
      </aside>
    </div>
  </div>

  <!-- Modal de confirmación (siempre centrado, con wrapper) -->
  <div class="rs-modal-backdrop" *ngIf="showModal">
    <div class="rs-modal" role="dialog" aria-modal="true">
      <div class="rs-modal__header">
        <h3>¡Reserva creada!</h3>
      </div>

      <div class="rs-modal__body">
        <p class="code">
          Código: <strong>{{ reservationCode }}</strong>
        </p>

        <ul class="resume">
          <li><span>Hotel:</span> {{ hotelName || 'Hotel #' + hotelId }}</li>
          <li>
            <span>Habitación:</span>
            {{ selectedRoom?.number }} — Piso {{ selectedRoom?.floor }}
            <ng-container *ngIf="selectedRoom?.theme_name || selectedRoom?.themeName">
              — {{ selectedRoom?.theme_name || selectedRoom?.themeName }}
            </ng-container>
          </li>
          <li>
            <span>Categoría:</span> {{ typeName }}
            <ng-container *ngIf="capacity"> (Cap. {{ capacity }})</ng-container>
          </li>

          <!-- Cliente -->
          <li *ngIf="clientName"><span>Cliente:</span> {{ clientName }}</li>
          <li *ngIf="clientUsername"><span>Usuario:</span> {{ clientUsername }}</li>
          <li *ngIf="clientEmail"><span>Email:</span> {{ clientEmail }}</li>
          <li *ngIf="clientPhone"><span>Teléfono:</span> {{ clientPhone }}</li>
          <li *ngIf="clientDocNumber">
            <span>Documento:</span>
            <ng-container *ngIf="clientDocType">{{ clientDocType }} — </ng-container>
            {{ clientDocNumber }}
          </li>
          <li *ngIf="clientCountry"><span>País:</span> {{ clientCountry }}</li>
          <li *ngIf="clientAddress"><span>Dirección:</span> {{ clientAddress }}</li>
          <li *ngIf="clientRolesLabel"><span>Roles:</span> {{ clientRolesLabel }}</li>

          <li><span>Check-in:</span> {{ reserveForm.value?.checkIn }}</li>
          <li><span>Check-out:</span> {{ reserveForm.value?.checkOut }}</li>
          <li><span>Noches:</span> {{ nights() }}</li>
          <li *ngIf="estimatedTotal() as total">
            <span>Estimado:</span> {{ total | currency : 'COP' : 'symbol' : '1.0-0' }}
          </li>
        </ul>
      </div>

      <div class="rs-modal__actions">
        <button class="primary" (click)="closeModalGoHome()">Ir al inicio</button>
      </div>
    </div>
  </div>
</section>
