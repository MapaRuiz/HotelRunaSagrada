<ng-container *ngIf="isBrowser && !editing && !selected">
  <details #createDetails (toggle)="onCreateToggle($event)">
    <summary>Crear reserva</summary>

    <form *ngIf="showCreate" class="card mt-4 reservation-form">
      <div class="card-body row g-3">
        <h5 class="card-title col-12">Nueva reserva</h5>

        <div class="col-md-6">
          <label class="form-label">Cliente</label>
          <select class="form-select input-soft" [(ngModel)]="draft.user_id" name="client" required>
            <option [ngValue]="undefined">Seleccione cliente…</option>
            <option *ngFor="let u of users" [ngValue]="u.user_id">
              {{ u.full_name }} ({{ u.email }})
            </option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Hotel</label>
          <select
            class="form-select input-soft"
            [(ngModel)]="draft.hotel_id"
            (ngModelChange)="onHotelChange($event)"
            name="hotel"
            required
          >
            <option [ngValue]="undefined">Seleccione hotel…</option>
            <option *ngFor="let h of hotels" [ngValue]="h.hotel_id">
              {{ h.name }}
            </option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Habitación</label>
          <select
            class="form-select input-soft"
            [(ngModel)]="draft.room_id"
            name="room"
            [disabled]="!draft.hotel_id"
            required
          >
            <option [ngValue]="undefined" *ngIf="!draft.hotel_id">
              Seleccione un hotel primero
            </option>
            <option [ngValue]="undefined" *ngIf="draft.hotel_id && !roomsForForm.length">
              No hay habitaciones
            </option>
            <option *ngFor="let r of roomsForForm" [ngValue]="r.room_id">
              {{ r.number }}
            </option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Estado</label>
          <select class="form-select input-soft" [(ngModel)]="draft.status" name="status" required>
            <option value="PENDING">Pendiente</option>
            <option value="CONFIRMED">Confirmada</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Check-in</label>
          <input
            class="form-control input-soft"
            [(ngModel)]="draft.check_in"
            name="checkin"
            type="date"
            required
          />
        </div>

        <div class="col-md-6">
          <label class="form-label">Check-out</label>
          <input
            class="form-control input-soft"
            [(ngModel)]="draft.check_out"
            name="checkout"
            type="date"
            required
          />
        </div>

        <div class="col-12 text-end">
          <button
            class="btn btn-outline-olive me-2"
            (click)="cancelCreate()"
            [disabled]="createLoading"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-olive" (click)="save()" [disabled]="createLoading">
            {{ createLoading ? 'Guardando...' : 'Guardar' }}
          </button>
        </div>
      </div>
    </form>
  </details>

  <div class="mt-3 mb-2">
    <input
      type="search"
      class="form-control input-soft"
      placeholder="Buscar reservas…"
      [value]="search"
      (input)="onSearch($any($event.target).value)"
    />
  </div>
  <div class="reservations-grid-wrap">
    <div *ngIf="loading" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando reservas...</p>
    </div>

    <ag-grid-angular
      *ngIf="!loading"
      [theme]="gridTheme"
      [gridOptions]="gridOptions"
      [rowData]="rowData"
      [pagination]="true"
      style="width: 100%; height: 400px"
    >
    </ag-grid-angular>

    <div *ngIf="!loading && rowData.length === 0" class="text-center p-4">
      <p class="text-muted">No hay reservas para mostrar.</p>
      <p class="text-muted small">Crea una nueva reserva usando el botón "Crear reserva" arriba.</p>
      <p class="text-muted small">Datos cargados: {{ rowData.length }} reservas</p>
    </div>
  </div>
</ng-container>

<!-- Detail Form -->
<app-reservation-detail
  *ngIf="selected && !editing"
  [reservation]="selected"
  (editRequested)="onDetailEdit($event)"
></app-reservation-detail>

<!-- Edit Form -->
<form *ngIf="editing" class="card mt-4 reservation-form">
  <div class="card-body row g-3">
    <h5 class="card-title col-12">Editar reserva</h5>

    <div class="col-md-6">
      <label class="form-label">Cliente</label>
      <select class="form-select input-soft" [(ngModel)]="draft.user_id" name="client" required>
        <option [ngValue]="undefined">Seleccione cliente…</option>
        <option *ngFor="let u of users" [ngValue]="u.user_id">
          {{ u.full_name }} ({{ u.email }})
        </option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Hotel</label>
      <select
        class="form-select input-soft"
        [(ngModel)]="draft.hotel_id"
        (ngModelChange)="onHotelChange($event)"
        name="hotel"
        required
      >
        <option [ngValue]="undefined">Seleccione hotel…</option>
        <option *ngFor="let h of hotels" [ngValue]="h.hotel_id">
          {{ h.name }}
        </option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Habitación</label>
      <select
        class="form-select input-soft"
        [(ngModel)]="draft.room_id"
        name="room"
        [disabled]="!draft.hotel_id"
        required
      >
        <option [ngValue]="undefined" *ngIf="!draft.hotel_id">Seleccione un hotel primero</option>
        <option [ngValue]="undefined" *ngIf="draft.hotel_id && !roomsForForm.length">
          No hay habitaciones
        </option>
        <option *ngFor="let r of roomsForForm" [ngValue]="r.room_id">
          {{ r.number }}
        </option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Estado</label>
      <select class="form-select input-soft" [(ngModel)]="draft.status" name="status" required>
        <option value="PENDING">Pendiente</option>
        <option value="CONFIRMED">Confirmada</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Check-in</label>
      <input
        class="form-control input-soft"
        [(ngModel)]="draft.check_in"
        name="checkin"
        type="date"
        required
      />
    </div>

    <div class="col-md-6">
      <label class="form-label">Check-out</label>
      <input
        class="form-control input-soft"
        [(ngModel)]="draft.check_out"
        name="checkout"
        type="date"
        required
      />
    </div>

    <div class="col-12 text-end">
      <button class="btn btn-outline-olive me-2" (click)="cancelEdit()" [disabled]="loading">
        Cancelar
      </button>
      <button type="submit" class="btn btn-olive" (click)="save()" [disabled]="loading">
        {{ loading ? 'Guardando...' : 'Guardar' }}
      </button>
    </div>
  </div>
</form>
