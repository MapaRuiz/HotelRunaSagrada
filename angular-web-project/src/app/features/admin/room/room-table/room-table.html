<ng-container *ngIf="isBrowser && !editing && !selected">
  <details #createDetails (toggle)="onCreateToggle($event)">
    <summary>Crear habitación</summary>

    <form *ngIf="showCreate" class="card mt-4 room-form">
      <div class="card-body row g-3">
        <h5 class="card-title col-12">Nueva habitación</h5>

        <div class="col-md-6">
          <label class="form-label">Hotel</label>
          <select class="form-select input-soft" [(ngModel)]="draft_hotel_id" name="hotel" required>
            <option [ngValue]="undefined">Selecciona hotel…</option>
            <option *ngFor="let h of hotels" [ngValue]="h.hotel_id">{{ h.name }}</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Tipo</label>
          <select
            class="form-select input-soft"
            [(ngModel)]="draft_room_type_id"
            name="roomType"
            required
          >
            <option [ngValue]="undefined">Selecciona tipo…</option>
            <option *ngFor="let t of types" [ngValue]="t.room_type_id">{{ t.name }}</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Número</label>
          <input
            class="form-control input-soft"
            [(ngModel)]="draft.number"
            name="number"
            placeholder="1-101"
            required
          />
        </div>

        <div class="col-md-6">
          <label class="form-label">Piso</label>
          <input
            type="number"
            class="form-control input-soft"
            [class.is-invalid]="draft.floor && (draft.floor < 1 || draft.floor > 5)"
            min="1"
            max="5"
            [(ngModel)]="draft.floor"
            name="floor"
            required
          />
          <div *ngIf="draft.floor && (draft.floor < 1 || draft.floor > 5)" class="invalid-feedback">
            El piso debe estar entre 1 y 5
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Estado de Reserva</label>
          <select
            class="form-select input-soft"
            [(ngModel)]="draft.res_status"
            name="resStatus"
            required
          >
            <option value="AVAILABLE">Disponible</option>
            <option value="BOOKED">Reservada</option>
            <option value="MAINTENANCE">Mantenimiento</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Estado de Limpieza</label>
          <select
            class="form-select input-soft"
            [(ngModel)]="draft.cle_status"
            name="cleStatus"
            required
          >
            <option value="CLEAN">Limpia</option>
            <option value="DIRTY">Sucia</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Tema</label>
          <input
            class="form-control input-soft"
            [(ngModel)]="draft.theme_name"
            name="theme"
            placeholder="Balcones Coloniales"
            required
          />
        </div>

        <!-- Imágenes -->
        <div class="col-12">
          <div class="imagenes-wrapper">
            <div
              class="imagenes-header d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2"
            >
              <label class="form-label mb-0">Imágenes</label>
              <div class="btn-group btn-group-sm" role="group">
                <button
                  type="button"
                  class="btn btn-outline-olive"
                  [class.active]="displayMode === 'carousel'"
                  (click)="setDisplayMode('carousel')"
                >
                  Carrusel
                </button>
                <button
                  type="button"
                  class="btn btn-outline-olive"
                  [class.active]="displayMode === 'list'"
                  (click)="setDisplayMode('list')"
                >
                  Lista
                </button>
              </div>
            </div>

            <div class="imagenes-input input-group mb-3">
              <input
                type="url"
                class="form-control input-soft"
                placeholder="https://ejemplo.com/imagen.jpg"
                [(ngModel)]="newImageUrl"
                name="newImageUrl"
              />
              <button class="btn btn-olive" type="button" (click)="addImage()">Añadir</button>
            </div>

            <div *ngIf="draft.images.length; else noImages" class="imagenes-body">
              <ng-container [ngSwitch]="displayMode">
                <div
                  *ngSwitchCase="'carousel'"
                  class="carousel slide mb-3 position-relative imagenes-content"
                >
                  <div class="carousel-inner carousel-stage">
                    <div
                      *ngFor="let src of draft.images; let i = index; trackBy: trackByIndex"
                      class="carousel-item"
                      [class.active]="i === activeSlide"
                      [attr.aria-hidden]="i !== activeSlide"
                    >
                      <div class="carousel-frame">
                        <img
                          [src]="src"
                          class="carousel-img"
                          alt="Imagen {{ i + 1 }}"
                          (load)="onImgLoad(i)"
                          (error)="onImgError(i)"
                          [class.opacity-0]="imageStatus[i] !== 'loaded'"
                        />
                        <div
                          *ngIf="imageStatus[i] === 'idle'"
                          class="carousel-overlay carousel-overlay-light"
                        >
                          <span class="fw-bold text-secondary">Cargando…</span>
                        </div>
                        <div
                          *ngIf="imageStatus[i] === 'error'"
                          class="carousel-overlay carousel-overlay-error"
                        >
                          <i class="bi bi-exclamation-triangle-fill fs-2"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <button
                    class="carousel-control-prev"
                    type="button"
                    (click)="prev()"
                    [disabled]="draft.images.length < 2"
                  >
                    <span class="carousel-control-prev-icon"></span>
                    <span class="visually-hidden">Anterior</span>
                  </button>
                  <button
                    class="carousel-control-next"
                    type="button"
                    (click)="next()"
                    [disabled]="draft.images.length < 2"
                  >
                    <span class="carousel-control-next-icon"></span>
                    <span class="visually-hidden">Siguiente</span>
                  </button>
                </div>

                <div *ngSwitchCase="'list'" class="imagenes-content imagenes-list">
                  <ul class="list-group">
                    <li
                      *ngFor="let src of draft.images; let i = index; trackBy: trackByIndex"
                      class="list-group-item d-flex justify-content-between align-items-center"
                    >
                      <div class="me-2 text-truncate" style="max-width: 70%">
                        {{ src }}
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <span *ngIf="imageStatus[i] === 'error'" class="badge text-bg-danger"
                          >Error</span
                        >
                        <span *ngIf="imageStatus[i] === 'loaded'" class="badge text-bg-success"
                          >OK</span
                        >
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-danger"
                          (click)="removeImage(i)"
                        >
                          Eliminar
                        </button>
                      </div>
                    </li>
                  </ul>
                </div>
              </ng-container>
            </div>
          </div>
          <div
            *ngIf="displayMode === 'carousel'"
            class="d-flex flex-wrap justify-content-end gap-2 mb-3"
          >
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              (click)="removeActiveImage()"
              [disabled]="draft.images.length === 0"
            >
              Quitar imagen actual
            </button>
          </div>
        </div>

        <ng-template #noImages>
          <div class="text-muted fst-italic">No hay imágenes todavía.</div>
        </ng-template>

        <div class="col-12 text-end">
          <button
            class="btn btn-outline-olive me-2"
            (click)="cancelCreate()"
            [disabled]="createLoading"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-olive"
            (click)="save()"
            [disabled]="createLoading || (draft.floor && (draft.floor < 1 || draft.floor > 5))"
          >
            {{ createLoading ? 'Guardando...' : 'Guardar' }}
          </button>
        </div>
      </div>
    </form>
  </details>

  <div class="mt-3 mb-2">
    <input
      type="search"
      class="form-control input-soft"
      placeholder="Buscar habitaciones…"
      [value]="search"
      (input)="onSearch($any($event.target).value)"
    />
  </div>
  <div class="rooms-grid-wrap">
    <ag-grid-angular
      [theme]="gridTheme"
      [gridOptions]="gridOptions"
      [rowData]="rowData"
      [pagination]="true"
      style="width: 100%; height: 100%"
    >
    </ag-grid-angular>
  </div>
</ng-container>

<!-- Detail Form -->
<app-room-detail
  *ngIf="selected && !editing"
  [room]="selected"
  (editRequested)="onDetailEdit($event)"
></app-room-detail>

<!-- Edit Form -->
<form *ngIf="editing" class="card mt-4 room-form">
  <div class="card-body row g-3">
    <h5 class="card-title col-12">Editar habitación</h5>

    <div class="col-md-6">
      <label class="form-label">Hotel</label>
      <select class="form-select input-soft" [(ngModel)]="draft_hotel_id" name="hotel" required>
        <option [ngValue]="undefined">Selecciona hotel…</option>
        <option *ngFor="let h of hotels" [ngValue]="h.hotel_id">{{ h.name }}</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Tipo</label>
      <select
        class="form-select input-soft"
        [(ngModel)]="draft_room_type_id"
        name="roomType"
        required
      >
        <option [ngValue]="undefined">Selecciona tipo…</option>
        <option *ngFor="let t of types" [ngValue]="t.room_type_id">{{ t.name }}</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Número</label>
      <input
        class="form-control input-soft"
        [(ngModel)]="draft.number"
        name="number"
        placeholder="1-101"
        required
      />
    </div>

    <div class="col-md-6">
      <label class="form-label">Piso</label>
      <input
        type="number"
        class="form-control input-soft"
        [class.is-invalid]="draft.floor && (draft.floor < 1 || draft.floor > 5)"
        min="1"
        max="5"
        [(ngModel)]="draft.floor"
        name="floor"
        required
      />
      <div *ngIf="draft.floor && (draft.floor < 1 || draft.floor > 5)" class="invalid-feedback">
        El piso debe estar entre 1 y 5
      </div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Estado de Reserva</label>
      <select
        class="form-select input-soft"
        [(ngModel)]="draft.res_status"
        name="resStatus"
        required
      >
        <option value="AVAILABLE">Disponible</option>
        <option value="BOOKED">Reservada</option>
        <option value="MAINTENANCE">Mantenimiento</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Estado de Limpieza</label>
      <select
        class="form-select input-soft"
        [(ngModel)]="draft.cle_status"
        name="cleStatus"
        required
      >
        <option value="CLEAN">Limpia</option>
        <option value="DIRTY">Sucia</option>
      </select>
    </div>

    <div class="col-12">
      <label class="form-label">Tema</label>
      <input
        class="form-control input-soft"
        [(ngModel)]="draft.theme_name"
        name="theme"
        placeholder="Balcones Coloniales"
        required
      />
    </div>

    <!-- Imágenes -->
    <div class="col-12">
      <div class="imagenes-wrapper">
        <div
          class="imagenes-header d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2"
        >
          <label class="form-label mb-0">Imágenes</label>
          <div class="btn-group btn-group-sm" role="group">
            <button
              type="button"
              class="btn btn-outline-olive"
              [class.active]="displayMode === 'carousel'"
              (click)="setDisplayMode('carousel')"
            >
              Carrusel
            </button>
            <button
              type="button"
              class="btn btn-outline-olive"
              [class.active]="displayMode === 'list'"
              (click)="setDisplayMode('list')"
            >
              Lista
            </button>
          </div>
        </div>

        <div class="imagenes-input input-group mb-3">
          <input
            type="url"
            class="form-control input-soft"
            placeholder="https://ejemplo.com/imagen.jpg"
            [(ngModel)]="newImageUrl"
            name="newImageUrl"
          />
          <button class="btn btn-olive" type="button" (click)="addImage()">Añadir</button>
        </div>

        <div *ngIf="draft.images.length; else noImagesEdit" class="imagenes-body">
          <ng-container [ngSwitch]="displayMode">
            <div
              *ngSwitchCase="'carousel'"
              class="carousel slide mb-3 position-relative imagenes-content"
            >
              <div class="carousel-inner carousel-stage">
                <div
                  *ngFor="let src of draft.images; let i = index; trackBy: trackByIndex"
                  class="carousel-item"
                  [class.active]="i === activeSlide"
                  [attr.aria-hidden]="i !== activeSlide"
                >
                  <div class="carousel-frame">
                    <img
                      [src]="src"
                      class="carousel-img"
                      alt="Imagen {{ i + 1 }}"
                      (load)="onImgLoad(i)"
                      (error)="onImgError(i)"
                      [class.opacity-0]="imageStatus[i] !== 'loaded'"
                    />
                    <div
                      *ngIf="imageStatus[i] === 'idle'"
                      class="carousel-overlay carousel-overlay-light"
                    >
                      <span class="fw-bold text-secondary">Cargando…</span>
                    </div>
                    <div
                      *ngIf="imageStatus[i] === 'error'"
                      class="carousel-overlay carousel-overlay-error"
                    >
                      <i class="bi bi-exclamation-triangle-fill fs-2"></i>
                    </div>
                  </div>
                </div>
              </div>
              <button
                class="carousel-control-prev"
                type="button"
                (click)="prev()"
                [disabled]="draft.images.length < 2"
              >
                <span class="carousel-control-prev-icon"></span>
                <span class="visually-hidden">Anterior</span>
              </button>
              <button
                class="carousel-control-next"
                type="button"
                (click)="next()"
                [disabled]="draft.images.length < 2"
              >
                <span class="carousel-control-next-icon"></span>
                <span class="visually-hidden">Siguiente</span>
              </button>
            </div>

            <div *ngSwitchCase="'list'" class="imagenes-content imagenes-list">
              <ul class="list-group">
                <li
                  *ngFor="let src of draft.images; let i = index; trackBy: trackByIndex"
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <div class="me-2 text-truncate" style="max-width: 70%">
                    {{ src }}
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span *ngIf="imageStatus[i] === 'error'" class="badge text-bg-danger"
                      >Error</span
                    >
                    <span *ngIf="imageStatus[i] === 'loaded'" class="badge text-bg-success"
                      >OK</span
                    >
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger"
                      (click)="removeImage(i)"
                    >
                      Eliminar
                    </button>
                  </div>
                </li>
              </ul>
            </div>
          </ng-container>
        </div>
      </div>
      <div
        *ngIf="displayMode === 'carousel'"
        class="d-flex flex-wrap justify-content-end gap-2 mb-3"
      >
        <button
          type="button"
          class="btn btn-sm btn-outline-danger"
          (click)="removeActiveImage()"
          [disabled]="draft.images.length === 0"
        >
          Quitar imagen actual
        </button>
      </div>
    </div>

    <ng-template #noImagesEdit>
      <div class="text-muted fst-italic">No hay imágenes todavía.</div>
    </ng-template>

    <div class="col-12 text-end">
      <button class="btn btn-outline-olive me-2" (click)="cancelEdit()" [disabled]="loading">
        Cancelar
      </button>
      <button
        type="submit"
        class="btn btn-olive"
        (click)="saveEdit()"
        [disabled]="loading || (draft.floor && (draft.floor < 1 || draft.floor > 5))"
      >
        {{ loading ? 'Guardando...' : 'Guardar' }}
      </button>
    </div>
  </div>
</form>
