<h4>Mi perfil</h4>

<div class="card card-body mt-3">
  <form #f="ngForm" (ngSubmit)="save(f)">
    <div class="row g-3">
      <div class="col-md-4 text-center">
        <div class="mb-2">Foto de perfil</div>
        <div class="avatar-wrapper">
          <img
            [src]="img(draft.selected_pet)"
            (error)="imgBroken = true"
            (load)="imgBroken = false"
            alt="Avatar"
            class="avatar-preview"
          />
          <div *ngIf="imgBroken" class="text-danger small mt-1">No se pudo cargar la imagen</div>
        </div>
        <input
          class="form-control mt-2"
          name="selected_pet"
          [(ngModel)]="draft.selected_pet"
          placeholder="/images/icons/icono.png o https://..."
        />
      </div>

      <div class="col-md-8">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Nombre completo</label>
            <input class="form-control" name="full_name" [(ngModel)]="draft.full_name" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Teléfono</label>
            <input class="form-control" name="phone" [(ngModel)]="draft.phone" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Documento</label>
            <input class="form-control" name="national_id" [(ngModel)]="draft.national_id" />
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2 justify-content-end">
      <button class="btn btn-primary" type="submit" (mousedown)="editTouched = true">
        Guardar cambios
      </button>
      <button type="button" class="btn btn-danger" (click)="deleteAccount()">
        Eliminar cuenta
      </button>
    </div>
  </form>
</div>
<!-- Métodos de pago -->
<div class="card card-body mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="m-0">Métodos de pago</h5>
    <div>
      <button class="btn btn-sm btn-outline-primary" (click)="startAddPayment()">Añadir método</button>
    </div>
  </div>

  <div *ngIf="paymentMethods?.length; else noPayments">
    <ul class="list-group">
      <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let p of paymentMethods">
        <div>
          <div class="fw-semibold">{{ p.type }} {{ p.last4 ? ('•••• ' + p.last4) : '' }}</div>
          <div class="small text-secondary">
            {{ p.holder_name || '-' }}<br />
            <span *ngIf="p.billing_address" class="text-muted">{{ p.billing_address }}</span>
          </div>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-2" (click)="startEditPayment(p)">Editar</button>
          <button class="btn btn-sm btn-outline-danger" (click)="deletePayment(p)">Eliminar</button>
        </div>
      </li>
    </ul>
  </div>

  <ng-template #noPayments>
    <div class="text-muted small">No hay métodos de pago registrados.</div>
  </ng-template>

  <div *ngIf="editingPayment" class="mt-3">
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Tipo</label>
        <select class="form-select" [(ngModel)]="editingPayment.type" name="pm_type">
          <option value="TARJETA">Tarjeta</option>
          <option value="PAYPAL">PayPal</option>
          <option value="EFECTIVO">Efectivo</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Últimos 4</label>
        <input class="form-control" name="pm_last4" [(ngModel)]="editingPayment.last4" maxlength="4" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Titular</label>
        <input class="form-control" name="pm_holder" [(ngModel)]="editingPayment.holder_name" />
      </div>
    </div>

    <div class="mt-2">
      <label class="form-label">Dirección de facturación</label>
      <input
        class="form-control"
        name="pm_address"
        [(ngModel)]="editingPayment.billing_address"
        placeholder="Calle, número, ciudad..."
      />
    </div>

    <div class="mt-3 d-flex gap-2 justify-content-end">
      <button class="btn btn-primary btn-sm" (click)="savePayment()">Guardar método</button>
      <button class="btn btn-outline-secondary btn-sm" (click)="cancelEditPayment()">Cancelar</button>
    </div>
  </div>
</div>

