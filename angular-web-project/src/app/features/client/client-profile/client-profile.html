<div class="profile-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="page-title mb-0"><i class="bi bi-person-circle me-2"></i>Mi Perfil</h3>
  </div>

  <div class="card-elev p-4 mb-4">
    <form #f="ngForm" (ngSubmit)="save(f)">
      <div class="row g-4">
        <!-- Avatar Section -->
        <div class="col-md-4">
          <div class="avatar-section text-center">
            <div class="mb-3">
              <label class="form-label fw-semibold">Foto de Perfil</label>
            </div>
            <div class="avatar-wrapper mx-auto">
              <img
                [src]="img(draft.selected_pet)"
                (error)="imgBroken = true"
                (load)="imgBroken = false"
                alt="Avatar"
                class="avatar-preview"
              />
              <div class="avatar-overlay">
                <i class="bi bi-camera-fill"></i>
              </div>
            </div>
            <div *ngIf="imgBroken" class="alert alert-warning small mt-2">
              <i class="bi bi-exclamation-triangle me-1"></i>
              No se pudo cargar la imagen
            </div>
            <div class="mt-3">
              <label class="form-label small text-secondary">URL de la imagen</label>
              <input
                class="form-control input-soft"
                name="selected_pet"
                [(ngModel)]="draft.selected_pet"
                placeholder="/images/icons/icono.png"
              />
            </div>
          </div>
        </div>

        <!-- Info Section -->
        <div class="col-md-8">
          <div class="info-section">
            <h5 class="section-title mb-3">
              <i class="bi bi-info-circle me-2"></i>Información Personal
            </h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label"> <i class="bi bi-person me-1"></i>Nombre completo </label>
                <input
                  class="form-control input-soft"
                  name="full_name"
                  [(ngModel)]="draft.full_name"
                  placeholder="Ingresa tu nombre completo"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label"> <i class="bi bi-envelope me-1"></i>Email </label>
                <input
                  class="form-control input-soft"
                  name="email"
                  [value]="me?.email"
                  disabled
                  readonly
                  title="Email del usuario"
                />
                <small class="text-muted">El email no puede ser modificado</small>
              </div>
              <div class="col-md-6">
                <label class="form-label"> <i class="bi bi-telephone me-1"></i>Teléfono </label>
                <input
                  class="form-control input-soft"
                  name="phone"
                  [(ngModel)]="draft.phone"
                  placeholder="+57 300 123 4567"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">
                  <i class="bi bi-card-text me-1"></i>Documento de Identidad
                </label>
                <input
                  class="form-control input-soft"
                  name="national_id"
                  [(ngModel)]="draft.national_id"
                  placeholder="123456789"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="mt-4 pt-3 border-top d-flex gap-2 justify-content-end">
        <button class="btn btn-olive px-4" type="submit" (mousedown)="editTouched = true">
          <i class="bi bi-check-circle me-2"></i>Guardar Cambios
        </button>
        <button type="button" class="btn btn-outline-danger px-4" (click)="deleteAccount()">
          <i class="bi bi-trash me-2"></i>Eliminar Cuenta
        </button>
      </div>
    </form>
  </div>

  <!-- Métodos de pago -->
  <div class="card-elev p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="m-0 fw-semibold">Métodos de pago</h5>
      <div>
        <button class="btn btn-sm btn-olive" (click)="startAddPayment()">Añadir método</button>
      </div>
    </div>

    <div *ngIf="paymentMethods?.length; else noPayments">
      <div class="payment-list">
        <div class="payment-item" *ngFor="let p of paymentMethods">
          <div class="payment-info">
            <div class="fw-semibold">{{ p.type }} {{ p.last4 ? '•••• ' + p.last4 : '' }}</div>
            <div class="small text-secondary">
              {{ p.holder_name || '-' }}<br />
              <span *ngIf="p.billing_address" class="text-muted">{{ p.billing_address }}</span>
            </div>
          </div>
          <div class="payment-actions">
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="startEditPayment(p)">
              Editar
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="deletePayment(p)">
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noPayments>
      <div class="text-muted small text-center py-3">No hay métodos de pago registrados.</div>
    </ng-template>

    <div *ngIf="editingPayment" class="mt-4 p-3 border rounded">
      <h6 class="fw-semibold mb-3">
        {{ editingPayment.method_id ? 'Editar' : 'Añadir' }} método de pago
      </h6>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold small">Tipo</label>
          <select
            class="input-soft"
            [(ngModel)]="editingPayment.type"
            name="pm_type"
            title="Tipo de método de pago"
          >
            <option value="TARJETA">Tarjeta</option>
            <option value="PAYPAL">PayPal</option>
            <option value="EFECTIVO">Efectivo</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold small">Últimos 4 dígitos</label>
          <input
            class="input-soft"
            name="pm_last4"
            [(ngModel)]="editingPayment.last4"
            maxlength="4"
            placeholder="1234"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold small">Titular</label>
          <input
            class="input-soft"
            name="pm_holder"
            [(ngModel)]="editingPayment.holder_name"
            placeholder="Nombre del titular"
          />
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label fw-semibold small">Dirección de facturación</label>
        <input
          class="input-soft"
          name="pm_address"
          [(ngModel)]="editingPayment.billing_address"
          placeholder="Calle, número, ciudad..."
        />
        />
      </div>

      <div class="mt-3 d-flex gap-2 justify-content-end">
        <button class="btn btn-primary btn-sm" (click)="savePayment()">Guardar método</button>
        <button class="btn btn-outline-secondary btn-sm" (click)="cancelEditPayment()">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
