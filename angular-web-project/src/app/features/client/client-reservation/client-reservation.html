<div class="client-reservations card-elev">
  <div class="client-reservations__header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Gestiona tus reservas</h5>
  </div>

  <div class="client-reservations__body">
    <div *ngIf="alert" class="alert py-2 px-3 alert-{{ alert.kind }}" role="alert">
      {{ alert.message }}
    </div>

    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <div class="small text-muted mt-2">Cargando reservas...</div>
    </div>

    <ng-container *ngIf="!loading">
      <ng-container *ngIf="!showDetail; else detailView">
        <div *ngIf="!reservations.length" class="text-center text-muted py-4">
          Aún no tienes reservas registradas.
        </div>

        <div class="table-responsive modern-table-wrapper" *ngIf="reservations.length">
          <table class="table table-hover align-middle table-modern">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Hotel</th>
                <th>Habitación</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let reservation of reservations">
                <tr
                  (click)="select(reservation)"
                  [class.table-active]="selected?.reservation_id === reservation.reservation_id"
                >
                  <td class="fw-semibold" data-label="Reserva">
                    #{{ reservation.reservation_id }}
                  </td>
                  <td data-label="Hotel">
                    {{ reservation.hotel?.name || 'Hotel ' + (reservation.hotel_id || '') }}
                  </td>
                  <td data-label="Habitación">
                    {{ reservation.room?.number || 'Habitación ' + (reservation.room_id || '') }}
                  </td>
                  <td data-label="Check-in">{{ formatDate(reservation.check_in) }}</td>
                  <td data-label="Check-out">{{ formatDate(reservation.check_out) }}</td>
                  <td data-label="Estado">
                    <span class="badge" [class]="badgeClass(reservation.status)">
                      {{ formatStatus(reservation.status) }}
                    </span>
                  </td>
                  <td class="text-end" data-label="Acciones">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-secondary me-2"
                      (click)="viewDetails(reservation, $event)"
                    >
                      Ver detalles
                    </button>
                    <ng-container *ngIf="reservation.status !== 'FINISHED'">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-primary me-2"
                        (click)="beginEdit(reservation); $event.stopPropagation()"
                      >
                        Editar
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        [disabled]="deletingId === reservation.reservation_id"
                        (click)="deleteReservation(reservation); $event.stopPropagation()"
                      >
                        <span
                          *ngIf="deletingId === reservation.reservation_id"
                          class="spinner-border spinner-border-sm me-1"
                        ></span>
                        Cancelar
                      </button>
                    </ng-container>
                  </td>
                </tr>
                <tr *ngIf="isEditing(reservation)" class="edit-row">
                  <td colspan="7" data-label="Editar">
                    <form class="row g-3 align-items-end">
                      <div class="col-12 col-md-6">
                        <label class="form-label">Check-in</label>
                        <input
                          type="date"
                          class="form-control"
                          name="checkIn"
                          [(ngModel)]="draft.check_in"
                        />
                      </div>
                      <div class="col-12 col-md-6">
                        <label class="form-label">Check-out</label>
                        <input
                          type="date"
                          class="form-control"
                          name="checkOut"
                          [(ngModel)]="draft.check_out"
                        />
                      </div>
                      <div class="col-12 d-flex flex-wrap justify-content-end gap-2">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-secondary"
                          (click)="cancelEdit()"
                        >
                          Cancelar
                        </button>
                        <button
                          type="button"
                          class="btn btn-sm btn-primary"
                          [disabled]="saving"
                          (click)="saveEdit()"
                        >
                          <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
                          Guardar cambios
                        </button>
                      </div>
                    </form>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>

      <ng-template #detailView>
        <div *ngIf="selected; else noSelection" class="detail-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Detalle de la reserva #{{ selected.reservation_id }}</h6>
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="backToList()">
              Volver al listado
            </button>
          </div>
          <app-reservation-detail
            [reservation]="selected"
            (editRequested)="beginEdit($event)"
          ></app-reservation-detail>
        </div>
        <ng-template #noSelection>
          <div class="text-center text-muted py-4">
            Selecciona una reserva para ver los detalles.
            <div class="mt-3">
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="backToList()">
                Volver
              </button>
            </div>
          </div>
        </ng-template>
      </ng-template>
    </ng-container>
  </div>
</div>
