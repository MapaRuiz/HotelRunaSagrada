<ng-container *ngIf="isBrowser && !showStaffView && !editing">
  <details #createDetails (toggle)="onCreateToggle($event)">
    <summary>Crear departamento</summary>

    <form *ngIf="showCreate" class="card mt-4 department-form">
      <div class="card-body row g-3">
        <h5 class="card-title col-12">Nuevo departamento</h5>

        <div class="col-md-6">
          <label class="form-label">Hotel</label>
          <select class="form-select input-soft" [(ngModel)]="draft.hotel_id" name="hotel" required>
            <option [ngValue]="undefined">Seleccione hotel…</option>
            <option *ngFor="let h of hotels" [ngValue]="h.hotel_id">
              {{ h.name }}
            </option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Nombre del departamento</label>
          <input
            class="form-control input-soft"
            [(ngModel)]="draft.name"
            name="name"
            placeholder="Ej: Recepción, Limpieza, Mantenimiento"
            maxlength="100"
            required
          />
        </div>

        <div class="col-12 text-end">
          <button
            class="btn btn-outline-olive me-2"
            (click)="cancelCreate()"
            [disabled]="createLoading"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-olive"
            (click)="saveCreate()"
            [disabled]="createLoading"
          >
            {{ createLoading ? 'Guardando...' : 'Guardar' }}
          </button>
        </div>
      </div>
    </form>
  </details>

  <div class="mt-3 mb-2">
    <input
      type="search"
      class="form-control input-soft"
      placeholder="Buscar departamentos…"
      [value]="search"
      (input)="onSearch($any($event.target).value)"
    />
  </div>

  <div class="departments-grid-wrap">
    <div *ngIf="loading" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando departamentos...</p>
    </div>

    <ag-grid-angular
      *ngIf="!loading"
      [theme]="gridTheme"
      [gridOptions]="gridOptions"
      [rowData]="rowData"
      [pagination]="true"
      style="width: 100%; height: 400px"
    >
    </ag-grid-angular>

    <div *ngIf="!loading && rowData.length === 0" class="text-center p-4">
      <p class="text-muted">No hay departamentos para mostrar.</p>
      <p class="text-muted small">
        Crea un nuevo departamento usando el botón "Crear departamento" arriba.
      </p>
      <p class="text-muted small">Datos cargados: {{ rowData.length }} departamentos</p>
    </div>
  </div>
</ng-container>

<!-- Edit Form -->
<form *ngIf="editing" class="card mt-4 department-form">
  <div class="card-body row g-3">
    <h5 class="card-title col-12">Editar departamento</h5>

    <div class="col-md-6">
      <label class="form-label">Hotel</label>
      <select class="form-select input-soft" [(ngModel)]="draft.hotel_id" name="hotel" required>
        <option [ngValue]="undefined">Seleccione hotel…</option>
        <option *ngFor="let h of hotels" [ngValue]="h.hotel_id">
          {{ h.name }}
        </option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Nombre del departamento</label>
      <input
        class="form-control input-soft"
        [(ngModel)]="draft.name"
        name="name"
        placeholder="Ej: Recepción, Limpieza, Mantenimiento"
        maxlength="100"
        required
      />
    </div>

    <div class="col-12 text-end">
      <button
        class="btn btn-outline-olive me-2"
        (click)="cancelCreate()"
        [disabled]="createLoading"
      >
        Cancelar
      </button>
      <button type="submit" class="btn btn-olive" (click)="saveCreate()" [disabled]="createLoading">
        {{ createLoading ? 'Guardando...' : 'Guardar' }}
      </button>
    </div>
  </div>
</form>

<div *ngIf="showStaffView && selectedDepartment">
  <app-staff-member-list
    [departmentId]="selectedDepartment.department_id"
    [departmentName]="selectedDepartment.name"
    (backToParent)="backToDepartments()"
  >
  </app-staff-member-list>
</div>
